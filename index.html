<script src="geo-map-component.js" type="module"></script>
<link rel="stylesheet" type="text/css" href="geo-map-component.css">
<style>
  body {
    background-color: black;
  }
  geo-map {
    width: 100%;
    height: 100%;
  }
</style>

<img src="https://uploads-ssl.webflow.com/5e97831f234469bc00deddc8/5e9efe510065a0094d1593cf_RE_Colored_Icon.svg" style="
  position: absolute;
  left: 20px;
  top: 20px;
  z-index: 9001;
  width: 50px;
  height: auto;

">
<geo-map
  id="geo_map"
  accesstoken=pk.eyJ1IjoicmVmbGVjdGl2ZS1lYXJ0aCIsImEiOiJja2VvZHd2YjgwMGJnMnhtcmVsOXRwMWR3In0.KgPtf7QYrYp5g0G2yrvGaA
  styleurl=mapbox://styles/reflective-earth/cl60yqkiw002o16msz3oc2bxb
  latitude= 37.7883697
  longitude=-122.3998664
  zoom=2
  bearing=0
  pitch=0
  navigation
  geolocate
  geocoder

>
</geo-map>

<script type="text/javascript">
  geo_map.addEventListener('loaded', function(){
    const map = geo_map.map

    let last_popup = null;

    const secondsPerRevolution = 120;
    // Above zoom level 5, do not rotate.
    const maxSpinZoom = 5;
    // Rotate at intermediate speeds between zoom levels 3 and 5.
    const slowSpinZoom = 3;
     
    let userInteracting = false;
    let spinEnabled = true;
     
    function spinGlobe() {
      const zoom = map.getZoom();
      if (spinEnabled && !userInteracting && zoom < maxSpinZoom) {
        let distancePerSecond = 360 / secondsPerRevolution;
        if (zoom > slowSpinZoom) {
          // Slow spinning at higher zooms
          const zoomDif =
          (maxSpinZoom - zoom) / (maxSpinZoom - slowSpinZoom);
          distancePerSecond *= zoomDif;
        }
        const center = map.getCenter();
        center.lng -= distancePerSecond;
        // Smoothly animate the map over one second.
        // When this animation is complete, it calls a 'moveend' event.
        map.easeTo({ center, duration: 1000, easing: (n) => n });
      }
    }
     
    // Pause spinning on interaction
    map.on('mousedown', () => {
      userInteracting = true;
    });
     
    // Restart spinning the globe when interaction is complete
    map.on('mouseup', () => {
      userInteracting = false;
      spinGlobe();
    });
     
    // These events account for cases where the mouse has moved
    // off the map, so 'mouseup' will not be fired.
    map.on('dragend', () => {
      userInteracting = false;
      spinGlobe();
    });
    map.on('pitchend', () => {
      userInteracting = false;
      spinGlobe();
    });
    map.on('rotateend', () => {
      userInteracting = false;
      spinGlobe();
    });
     
    // When animation is complete, start spinning if there is no ongoing interaction
    map.on('moveend', () => {
      spinGlobe();
    });

    spinGlobe();

    geo_map.addEventListener('LOCATION FOUND', (e) => {
      const coords = e.detail

      fetch(`https://reflective-earth.herokuapp.com/api/earthengine/${coords[1]}/${coords[0]}`).then(res => res.json())
        .then(res => {
          if(last_popup !== null){last_popup.remove();}
          last_popup = new mapboxgl.Popup({ closeOnClick: false })
            .setLngLat(coords)
            .setHTML(`
              <h1>WRI</h1>
              <p>Albedo: ${res.albedo}</p>
              <p>Outsolation: ${res.outsolation}</p>

              `)
            .addTo(map);

        })
    })

  })
</script>